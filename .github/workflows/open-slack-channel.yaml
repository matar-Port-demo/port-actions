name: Open Slack Channel

on:
  workflow_dispatch:
    inputs:
      port_payload:
        description: "Port's payload, including details for who triggered the action and general context (blueprint, run ID, etc...)."
        required: true

permissions:
  contents: read
  issues: write 

jobs:
  open-slack-channel:
    runs-on: ubuntu-latest
    env:
      PD_INCIDENT_ID: ${{ fromJson(inputs.port_payload).event.diff.after.identifier }}
      PD_INCIDENT_URL: ${{ fromJson(inputs.port_payload).event.diff.after.properties.url }}
      PD_INCIDENT_TITLE: ${{ fromJson(inputs.port_payload).event.diff.after.title }}
      PORT_INCIDENT_URL: https://app.getport.io/pagerdutyIncidentEntity?identifier=${{ fromJson(inputs.port_payload).event.diff.after.identifier }}


    steps:
      - uses: actions/checkout@v4

      - name: Log Github Issue Creation
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          logMessage: "Creating a new Github issue for this incident..."

      - uses: JasonEtco/create-an-issue@v2
        id: create-github-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log Executing Request to Open Channel
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          logMessage: | 
            Github issue created successfully - ${{ steps.create-github-issue.outputs.url }}

            Creating a new Slack channel for this incident...

      - name: Create Slack Channel
        id: create-slack-channel
        env:
          CHANNEL_NAME: incident-${{ env.PD_INCIDENT_ID }}
          SLACK_TOKEN: ${{ secrets.BOT_USER_OAUTH_TOKEN }}
        run: |
          response=$(curl -s -X POST "https://slack.com/api/conversations.create" \
            -H "Authorization: Bearer ${SLACK_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"$CHANNEL_NAME\"}")
        
          # Check if the channel was created successfully
          ok=$(echo $response | jq -r '.ok')
          
          if [ "$ok" == "true" ]; then
            echo "Channel '$CHANNEL_NAME' created successfully."
            channel_id=$(echo $response | jq -r '.channel.id')
            echo "SLACK_CHANNEL_ID=$channel_id" >> $GITHUB_OUTPUT
            echo "SLACK_CHANNEL_URL=https://slack.com/app_redirect?channel=$channel_id" >> GITHUB_OUTPUT
          else
            error=$(echo $response | jq -r '.error')
            echo "Error creating channel: $error"
            echo "SLACK_ERROR=$error" >> $GITHUB_OUPUT
            exit 1
          fi

      - name: Log failed Slack channel creation
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          logMessage: "Failed to create slack channel: ${{ steps.create-slack-channel.outputs.SLACK_ERROR }} ❌"

      - name: Log successful Slack channel creation
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          logMessage: |
            Channel created successfully - ${{ steps.create-slack-channel.outputs.SLACK_CHANNEL_URL }} ✅

            Adding relevant users to the slack channel...

      - name: Add Members to Slack Channel
        id: add_members
        if: success()
        env:
          SLACK_TOKEN: ${{ secrets.BOT_USER_OAUTH_TOKEN }}
          CHANNEL_ID: ${{ steps.create-slack-channel.outputs.SLACK_CHANNEL_ID }}
          CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
          CHANNEL_NAME: incident-${{ env.PD_INCIDENT_ID }}
          RUN_ID: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          # MEMBER_EMAILS: "('matar@getport.io', 'zohar@getport.io', 'bogu@getport.io', 'matanheled@getport.io')"
        run: |
          members=('matar@getport.io', 'zohar@getport.io', 'bogu@getport.io', 'matanheled@getport.io')
          for member in "${members[@]}"; do
            echo $member
            add_user_response=$(curl -s -X POST "https://slack.com/api/conversations.invite" \
                -H "Authorization: Bearer $SLACK_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"channel\":\"$CHANNEL_ID\", \"users\":\"$member\"}")
            
            user_ok=$(echo $add_user_response | jq -r '.ok')
            if [ "$user_ok" == "true" ]; then
                echo "User '$user_id' added to channel '$CHANNEL_NAME'."
            else
                user_error=$(echo $add_user_response | jq -r '.error')
                echo "Error adding user '$user_id' to channel: $user_error"
                exit 1
            fi
          done

      - name: Send Slack Message
        uses: archive/github-actions-slack@v2.0.0
        id: send-message

        with:
          slack-function: send-message
          slack-bot-user-oauth-access-token: ${{ secrets.BOT_USER_OAUTH_TOKEN }}
          slack-channel: ${{ steps.create-slack-channel.outputs.SLACK_CHANNEL_ID }}
          slack-text: | 
            ❗️ New Incident created - ${{ env.PD_INCIDENT_TITLE }}
            *  Urgency -
            * <${{ env.PD_INCIDENT_URL }}|Pagerduty incident>
            * <${{ steps.create-github-issue.outputs.url }}|Url to GitHub Issue>
            
            The affected service is <service name> with hyper link
            Upstream services that can be affected: 
            <list of upstream services with hyperlink as bonus> 

      - name: Log Successful Action
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_payload).run.id }}
          logMessage: |
            Added relevant users to the Slack channel ✅

            Successfully opened slack channel: ${{ env.CHANNEL_ID }} ✅

            Done reporting a handling the new incident
